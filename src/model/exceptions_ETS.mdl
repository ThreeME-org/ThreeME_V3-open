#---------------------------------------------------------------------------------------------------------------------------------------------
## I Intégration du coût de l'ETS pour les secteurs couverts

# remplacer l'equation 5.14 et 5.15 du bloc price pour intégrer le prix de l'ETS (energie ce et materiel cm et secteur/activity s):
# NB : on ne remplace l'équation que pour les biens énergétiques ce2 et non ce car la conso intermédiaire d'élec n'émet pas de cO2
@over PE[ce2,s]*E[ce2,s] = PED[ce2]*ED[ce2, s] + PEM[ce2]*EM[ce2, s] + TCO_VAL[ce2, s] + ETS_VAL_SEC[ce2, s] if E[ce2,s] <> 0
@over PMAT[cm, s]*MAT[cm, s] = PMATD[cm]*MATD[cm, s] + PMATM[cm]*MATM[cm, s] + ETS_VAL_DC[cm, s] if MAT[cm, s] <> 0

# Calcul ETS_VAL_SEC[ce, s] et ETS_VAL_DC[cm, s] le coût de l'ETS:
# notations:
# P_ETS : le prix du marché du permis ETS en euros constant 2006
# Q_ETS_free[s] : l'allocation annuelle gratuite des permis, pour le secteur s

# Calcul des ETS pour la decarbonation qui ne rentre pas en compe dans le prix de l'énergie mais dans le prix de MAT
delta_ETS_DC[cm, s] = ETScover_rate_DC[cm, s] * EMS_DC[s] where (cm, s) in (04, 04)
delta_ETS_DC[cm, s] = ETScover_rate_DC[cm, s] * EMS_DC[s] where (cm, s) in (05, 05)

# si effet_ETS_classique = 1 (option par défaut), les quotas gratuits n'entrent pas dans la demande de facteur de production, si effet_ETS_classique = 0, l'assiette de l'ETS est réduite des quotas gratuits 
delta_ETS_SEC[ce2, s] = (ETScover_rate[ce2,s] * EMS_SEC[ce2, s]) - (1 - effet_ETS_classique) * Q_ETS_free[s] * EMS_SEC[ce2, s] / EMS_SEC[s] if EMS_SEC[ce2, s] > 0

P_ETS_nominal = (P_ETS/1000000) * PGDP

ETS_VAL_SEC[ce2, s] = (P_ETS_nominal * delta_ETS_SEC[ce2, s]) if EMS_SEC[ce2, s] <> 0
ETS_VAL_DC[cm, s] = P_ETS_nominal * delta_ETS_DC[cm, s] where (cm, s) in (04, 04)
ETS_VAL_DC[cm, s] = P_ETS_nominal * delta_ETS_DC[cm, s] where (cm, s) in (05, 05)

EMS_SEC_TOT[s] = EMS_SEC[s] + EMS_DC[s]

ETS_VAL_SEC[s] = sum(ETS_VAL_SEC[ce2, s] on ce2) 

# Modification de l'équation de prix (5.1 bloc price) pour introduire le cas 2 :
# specification qui marche:
# Attention, PY_n est écrit en fonction de K,L,E,MAT et non en fonction de K_n,L_n,E_n,MAT_n car sinon ça faisait bugger le modèle. A voir comment modifier cela si besoin.
# si effet_ETS_classique = 1 (option par défaut), les quotas gratuits rentrent dans l'équation des prix de production sous forme de subvention à la production, pas si effet_ETS_classique = 0.
@over PY_n[s]*Y[s] = (CK[s]*K[s] + CL[s]*L[s]*PROG_L[s] + PE[s]*E[s] + PMAT[s]*MAT[s] + PIY[s]*IY[s] + PSY[s]*SY[s] + PIS[s]*IS[s] - effet_ETS_classique*P_ETS_nominal*Q_ETS_free[s]) * (1 + TMD[s]) if Y[s] > 0 where s in %list_sec


# pour activer l'option du TMD constant:
# equation 5.5
# @over d(log(1+TMD_n[s])) = 0 * ( d(log(Y[s])) - d(log(Y[s]{-1})) ) if Y[s] <> 0

#---------------------------------------------------------------------------------------------------------------------------------------------
## II réaffectation des recettes des enchères de l'ETS au secteur résidentiel sous forme de subvention

# Sub_ANAH_ETS : les recettes des enchères de l'ETS transférées à l'ANAH sous forme de subvention à l'investissement dans la rénovation, en euros constant 2006
# NB : Sub_ANAH_ETS est considéré comme un transfert exogène venu de l'UE
# remplacer l'équation de R_Sub qui intervient dans l'equation 4.57 du bloc hybridnew :
# rappel : équation 4.57 : PREHAB_delta[h,ecl] * REHAB[h,ecl] = sum( (1 - R_SUB[h,ecl,ecl2]) * PREHAB[h,ecl,ecl2] * REHAB[h,ecl,ecl2] / REHAB_D[h,ecl2] if REHAB[h,ecl,ecl2]  <> 0 on ecl2) if REHAB[h,ecl]  <> 0


Total_REHAB_VAL = sum(PREHAB[h, ecl, ecl2] * REHAB[h, ecl, ecl2] if REHAB[h,ecl,ecl2]  <> 0 on ecl, ecl2, h)
Sub_ANAH_ETS_nominal = (Sub_ANAH_ETS/1000000) * PGDP
delta_R_SUB[h, ecl, ecl2] = Sub_ANAH_ETS_nominal / Total_REHAB_VAL

R_SUB[h, ecl, ecl2] = R_SUB_Trend[h, ecl, ecl2] + delta_R_SUB[h, ecl, ecl2]
# NB : remplacement du R_SUB[h, ecl, ecl2] initialement défini en tant qu'exogène dans src\data\exceptions_hybrid_data.mdl => donc pas besoin de @over


# modification des transferts du gouvernement:
# ajout de la subvention dans les recettes du gouvernement (equation du fichier src\data\exceptions_fr_data.mdl)
@over REC_VAL = DIV_GOV_VAL + IR_VAL + AIC_VAL + INC_GOV_OTH_net - CL_S[sp] * L_S[sp] * PROG_L[sp] + value(Y[sp] + TAX + IY + IS + CSE_TOT + CSS_TOT - (E[sp] + MAT[sp] + IY[sp])) + Sub_ANAH_ETS_nominal


#---------------------------------------------------------------------------------------------------------------------------------------------
# III Modification of EU prices also impacted by the ETS

# PM, le prix des imports, devient une moyenne pondérée des prix étrangers EU et non EU:
# PWD_nonEU[c] prix étrangers non EU = PWD[c]
# PWD_EU[c] prix étrangers EU = PYQ[c]

#on fait l'hypothèse que les prix de l'UE évolue de la même façon que les prix domestiques du fait de l'ETS:

PWD_nonEU[c] = PWD[c]
PWD_EU[c] = PYQ[c]

@over d(log(PM[c])) = (1-Share_import_EU[c]) * d(log(TC * PWD_nonEU[c])) + Share_import_EU[c] * d(log(PWD_EU[c]))  where c in %list_com \ %list_com_E 
# on remplace l'equation de d(log(PM[c])) dans src/model/exceptions_fr.mdl (calé sur MESANGE)
# on exclut les biens énergétiques 
# NB : TC est exogène et égal à 1

#la part des imports entre l'UE et le reste du monde est endogénéisée 
Share_import_EU[c] = Share_import_EU[c]{-1} * (1 - ES_M_EU_RWD * d( log(PWD_EU[c]) - log(PWD_nonEU[c]) ) )   where c in %list_com \ %list_com_E 
# L'eslasticité des importations en provenance de l'UE et du reste du monde (ES_M_EU_RWD) doit être au moins égale à l'elasticité entre la production domestique et les importations. 

#pour les exports:
#remplacement de l'équation 2.39 dans C:\Users\nauleauml\Desktop\ThreeME\src\model\producer.mdl:
@over d(SUBST_X_n[c]) = -ES_X($c, 1) * d(log(PX[c]) - log(PM[c])) if X[c] <> 0  where c in %list_com \ %list_com_E 



